import sys
import requests

if len(sys.argv) < 2:
    print(f"Call: {sys.argv[0]} HOST PORT")
    sys.exit(1)


def xor_block(a, b):
    assert len(a) == len(b)
    res = bytearray()

    for i in range(len(a)):
        res.append(a[i]^b[i])
    
    return bytes(res)


HOST = sys.argv[1]
PORT = sys.argv[2]
BASE_URL = f"http://{HOST}:{PORT}/"
PREMIUM_URL = BASE_URL + "premium-info/CSR"


sess = requests.Session()
sess.get(BASE_URL)
enc_cookie = sess.cookies["user"]
cookie_raw = bytes.fromhex(enc_cookie)

iv, ct, mac = cookie_raw[:16], cookie_raw[16:-16], cookie_raw[-16:]

# "user": "stduser", "role": "pleb"
plaintext_block = b"user=stduser&rol"
plaintext_block_desired = b"role=premium&rol"

iv_diff = xor_block(plaintext_block, plaintext_block_desired)
iv_new = xor_block(iv, iv_diff)

new_cookie = (iv_new + ct + mac).hex()
sess.cookies["user"] = new_cookie

res = sess.get(PREMIUM_URL).text

if "CSR{" in res:
    print("Flag found:")
    fp = res.index("CSR{")
    # extra lazy today
    print(res[fp:fp+100])
else:
    print("Flag not found :(")
    sys.exit(2)
